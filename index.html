<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Resonance | 音霊フーリエ解析</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        body {
            background: radial-gradient(circle at top, #1b2340 0, #050816 45%, #02010d 100%);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-anim { animation: fadeUp 0.6s ease forwards; }
        
        .scope-container {
            position: relative;
            background: #02040a;
            border-radius: 0.75rem; 
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            border: 1px solid rgba(148,163,184,0.1);
        }

        /* 解説ボックス用のスタイル */
        .logic-box {
            background: rgba(15, 23, 42, 0.6);
            border-left: 2px solid #64748b;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.7;
        }
        .logic-title {
            font-weight: bold;
            color: #fcd34d; /* yellow-300 */
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }
    </style>
</head>
<body class="min-h-screen text-slate-100 selection:bg-yellow-400/30">

    <div class="min-h-screen flex flex-col">
        
        <header class="w-full border-b border-slate-800/60 bg-slate-950/20 backdrop-blur-sm sticky top-0 z-50">
            <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="h-9 w-9 rounded-full border border-yellow-400/60 flex items-center justify-center text-xs tracking-widest bg-yellow-400/10 text-yellow-300">
                        響
                    </div>
                    <div class="flex flex-col leading-tight">
                        <span class="font-semibold tracking-[0.2em] text-[10px] uppercase text-yellow-300/80">
                            Astro Resonance
                        </span>
                        <span class="font-cinzel font-semibold text-slate-50 text-lg tracking-wide">
                            Fourier Tuning
                        </span>
                    </div>
                </div>
                <div class="hidden md:block text-xs text-slate-500 tracking-widest">
                    V2.1 // LOGIC: VISIBLE
                </div>
            </div>
        </header>

        <main class="flex-1">
            <div class="mx-auto max-w-4xl px-4 pt-10 pb-20">

                <div class="text-center mb-12">
                    <p class="text-xs tracking-[0.35em] uppercase text-slate-400 mb-3">
                        Quantum Frequency Alignment
                    </p>
                    <h1 class="text-3xl md:text-4xl font-semibold mb-6 font-cinzel text-slate-100">
                        運命周波数の<span class="text-yellow-300">調律</span>
                    </h1>
                </div>

                <div id="step1" class="step-anim rounded-3xl border border-slate-800 bg-slate-900/50 p-6 md:p-8 mb-8 shadow-lg">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-slate-800 text-slate-300 text-xs px-2 py-1 rounded">STEP 01</span>
                        <h2 class="text-lg font-semibold text-slate-100">解析データの入力</h2>
                    </div>
                    
                    <div class="grid gap-6 md:grid-cols-2">
                        <div>
                            <label class="block text-xs tracking-wider text-slate-400 mb-2">NAME (HIRAGANA)</label>
                            <input type="text" id="inp-name" value="たなかたろう" placeholder="あかさ" 
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-yellow-400/50 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs tracking-wider text-slate-400 mb-2">BIRTH DATE</label>
                            <input type="date" id="inp-date" value="1995-08-08" 
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-yellow-400/50 transition-colors">
                        </div>
                    </div>

                    <div class="mt-8">
                        <button id="btn-analyze" onclick="app.analyzeSequence()" 
                            class="w-full md:w-auto md:px-12 py-3 rounded-full bg-slate-100 text-slate-900 font-semibold text-sm hover:bg-yellow-300 transition-colors shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                            運命周波数を解析する (Initialize)
                        </button>
                    </div>
                </div>

                <div id="step2" class="hidden rounded-3xl border border-yellow-400/30 bg-slate-900/60 p-6 md:p-8 mb-8 shadow-[0_0_30px_rgba(250,204,21,0.05)]">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-yellow-400/10 text-yellow-300 border border-yellow-400/20 text-xs px-2 py-1 rounded">STEP 02</span>
                        <h2 class="text-lg font-semibold text-yellow-100">守護周波数の生成</h2>
                    </div>

                    <div id="sanmei-result" class="mb-6 p-4 rounded-xl bg-slate-950/50 border border-slate-800/50"></div>

                    <div class="logic-box border-l-yellow-400/50">
                        <span class="logic-title">▼ 音霊生成ロジック：カタカムナ×周波数</span>
                        あなたの「名前の響き」は偶然ではありません。古代日本の「カタカムナ」では、一音一音に物理的なエネルギー（思念）が宿るとされています。<br>
                        本システムは、名前の音を対応する周波数に変換し、算命学で導き出された「不足エネルギー（守護要素）」と掛け合わせることで、あなたを本来のバランスへ戻すための<strong>【最適化された音】</strong>を生成しています。
                    </div>

                    <p class="text-sm text-slate-300 mb-6 leading-relaxed">
                        生成された波形は、あなたのエネルギーの「歪み」を整える補正信号です。<br>
                        下のモニタを確認しながら、音を再生してください。
                    </p>

                    <div class="scope-container h-48 md:h-64 mb-6 w-full">
                        <canvas id="visualizer" class="w-full h-full block"></canvas>
                        <div class="absolute top-2 right-3 text-[10px] text-yellow-500 font-mono opacity-70">
                            GAIN: <span id="gain-val">0.0</span> dB
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="btn-play" onclick="app.playSound()" 
                            class="w-full md:w-auto px-10 py-3 rounded-full bg-yellow-400 text-slate-950 font-bold text-sm hover:bg-yellow-300 transition-colors shadow-lg shadow-yellow-400/20">
                            ▶ 音霊を再生 (Play Resonance)
                        </button>
                    </div>
                </div>

                <div id="step3" class="hidden rounded-3xl border border-fuchsia-500/30 bg-slate-900/60 p-6 md:p-8 mb-8">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-fuchsia-500/10 text-fuchsia-300 border border-fuchsia-500/20 text-xs px-2 py-1 rounded">STEP 03</span>
                        <h2 class="text-lg font-semibold text-fuchsia-100">意識の同調（Vocal Sync）</h2>
                    </div>

                    <div class="logic-box border-l-fuchsia-500/50">
                        <span class="logic-title">▼ なぜ声を出すのか？（フーリエ変換による同調）</span>
                        音を聴くだけでは「受動的」な調整に留まります。自ら声を出し、守護音の周波数に波長を合わせることで、調整は「能動的」なものになります。<br>
                        <strong>フーリエ変換（Fourier Transform）</strong>とは、複雑な波（あなたの声）を、単純な波の集まりに分解する数学的処理です。
                        システムはあなたの声をリアルタイムで分解・解析し、守護周波数との「ズレ」を可視化します。このズレを自覚し、修正しようとすることで、脳波とチャクラが整います。
                    </div>
                    
                    <p class="text-sm text-slate-300 mb-8">
                        再生される音に合わせて、声（ハミング等）を出してください。<br>
                        デジタル波形と生体エネルギーの統合を行います。
                    </p>

                    <div class="flex gap-4">
                        <button id="btn-rec" onclick="app.startMic()" 
                            class="flex-1 py-3 rounded-full border border-fuchsia-400 text-fuchsia-300 font-semibold text-sm hover:bg-fuchsia-400 hover:text-slate-900 transition-colors">
                            ● 録音開始 (Rec)
                        </button>
                        <button id="btn-stop" onclick="app.stopMic()" disabled
                            class="flex-1 py-3 rounded-full bg-slate-800 text-slate-500 font-semibold text-sm disabled:opacity-50 enabled:bg-fuchsia-500 enabled:text-white enabled:hover:bg-fuchsia-400 transition-colors">
                            ■ 停止＆統合 (Merge)
                        </button>
                    </div>
                </div>

                <div id="step4" class="hidden rounded-3xl border border-slate-700 bg-slate-900/80 p-6 md:p-8 mb-10">
                    <div class="text-center mb-6">
                        <div class="inline-block px-3 py-1 rounded-full bg-teal-500/10 text-teal-300 border border-teal-500/20 text-xs mb-3">
                            SYNC COMPLETE
                        </div>
                        <h3 class="text-xl font-cinzel text-slate-100">共鳴・統合完了</h3>
                        <div id="voice-comment" class="mt-4 text-sm text-slate-300 leading-relaxed"></div>
                    </div>

                    <div class="relative h-64 w-full mb-8 bg-slate-950/50 rounded-xl border border-slate-800 p-2">
                        <canvas id="radarChart"></canvas>
                    </div>

                    <div class="text-center">
                        <button onclick="app.download()" 
                            class="px-8 py-3 rounded-full border border-slate-600 text-slate-300 text-sm hover:border-teal-400 hover:text-teal-300 transition-colors">
                            ↓ 共鳴ファイル(.wav)を保存
                        </button>
                    </div>
                </div>

            </div>
        </main>

        <footer class="border-t border-slate-800/80 bg-slate-950/60 text-center py-6">
            <div class="text-[10px] text-slate-600 tracking-widest uppercase">
                © 2025 Astro Resonance Fourier System
            </div>
        </footer>
    </div>

    <script>
        const Logic = {
            calcElements: function(dateStr) {
                const d = new Date(dateStr);
                const types = [
                    {n:"木性 (WOOD)", desc:"成長・直感", role:"魂の成長を促す", freq: 396}, 
                    {n:"火性 (FIRE)", desc:"情熱・変容", role:"行動力を点火する", freq: 528}, 
                    {n:"土性 (EARTH)", desc:"安定・接続", role:"基盤を固める", freq: 639}, 
                    {n:"金性 (METAL)", desc:"改革・収穫", role:"成果を具体化する", freq: 741}, 
                    {n:"水性 (WATER)", desc:"知性・柔軟", role:"流れを整える", freq: 852}  
                ];
                const val = d.getFullYear() + d.getMonth() + d.getDate();
                const myIdx = val % 5;
                const guardIdx = (myIdx + 2) % 5; 
                return { my: types[myIdx], guard: types[guardIdx] };
            }
        };

        const app = {
            ctx: null, analyzer: null, src: null, micSrc: null,
            isPlaying: false, animId: null, elements: null,
            
            init: function() {
                const p = new URLSearchParams(window.location.search);
                const dob = p.get('dob');
                const name = p.get('name');
                if(dob) {
                    const fmt = dob.substring(0,4)+'-'+dob.substring(4,6)+'-'+dob.substring(6,8);
                    document.getElementById('inp-date').value = fmt;
                    if(name) document.getElementById('inp-name').value = decodeURIComponent(name);
                    
                    // 自動実行の場合は少し待ってから演出開始
                    setTimeout(() => this.analyzeSequence(), 600);
                }
            },

            // ★変更点: 解析ボタンを押したときのシーケンス（演出）
            analyzeSequence: function() {
                const btn = document.getElementById('btn-analyze');
                const originalText = btn.innerText;
                
                // 1. ボタンを無効化＆ロード表示
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-wait');
                
                // 2. メッセージをパラパラ切り替える演出
                const messages = [
                    "Accessing Akashic Records...",
                    "Calculating Waveform...",
                    "Connecting to Universal Grid...",
                    "Synchronizing..."
                ];
                
                let count = 0;
                const interval = setInterval(() => {
                    btn.innerText = messages[count % messages.length];
                    count++;
                }, 500);

                // 3. 2秒後に解析実行
                setTimeout(() => {
                    clearInterval(interval);
                    this.analyze(); // 実際の解析
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-wait');
                }, 2000); // 2000ms = 2秒の間
            },

            analyze: function() {
                const date = document.getElementById('inp-date').value;
                if(!date) return alert("日付を入力してください");
                
                this.elements = Logic.calcElements(date);
                
                // ★変更点: 結果表示に解説（サブタイトル）を追加
                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-slate-900 rounded-lg p-3 border border-slate-800">
                            <div class="text-[10px] text-slate-500 mb-1 tracking-widest">SOUL TYPE</div>
                            <div class="text-sm font-semibold text-slate-200">${this.elements.my.n}</div>
                            <div class="text-[10px] text-slate-400 mt-1 border-t border-slate-800 pt-1">あなたの本質的性質</div>
                        </div>
                        <div class="bg-yellow-400/5 rounded-lg p-3 border border-yellow-400/30">
                            <div class="text-[10px] text-yellow-500 mb-1 tracking-widest">GUARDIAN (守護)</div>
                            <div class="text-sm font-bold text-yellow-300">${this.elements.guard.n}</div>
                            <div class="text-[10px] text-yellow-200/70 mt-1 border-t border-yellow-400/20 pt-1">${this.elements.guard.role}</div>
                        </div>
                        <div class="bg-slate-900 rounded-lg p-3 border border-slate-800">
                            <div class="text-[10px] text-slate-500 mb-1 tracking-widest">BASE FREQ</div>
                            <div class="text-sm font-mono text-slate-200">${this.elements.guard.freq} Hz</div>
                            <div class="text-[10px] text-slate-400 mt-1 border-t border-slate-800 pt-1">調整の基準周波数</div>
                        </div>
                    </div>
                `;
                document.getElementById('sanmei-result').innerHTML = html;
                
                this.showStep('step2');
                setTimeout(() => this.drawGridOnly(), 100);
            },

            initAudio: function() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyzer = this.ctx.createAnalyser();
                    this.analyzer.fftSize = 2048;
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },

            playSound: function() {
                if(this.isPlaying) return;
                this.initAudio();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                const baseFreq = this.elements.guard.freq;
                osc.frequency.setValueAtTime(baseFreq, this.ctx.currentTime);
                
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 0.5);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 5);
                
                osc.connect(gain);
                gain.connect(this.analyzer);
                gain.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + 5);
                
                this.isPlaying = true;
                const btn = document.getElementById('btn-play');
                btn.innerHTML = "Generating Waves...";
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                
                this.visualize();

                setTimeout(() => {
                    this.isPlaying = false;
                    btn.innerHTML = "▶ 音霊を再再生";
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    this.showStep('step3');
                }, 4000);
            },

            startMic: function() {
                this.initAudio();
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    this.micSrc = this.ctx.createMediaStreamSource(stream);
                    this.micSrc.connect(this.analyzer);
                    
                    const btnRec = document.getElementById('btn-rec');
                    btnRec.innerHTML = "● Recording...";
                    btnRec.classList.add('animate-pulse');
                    
                    document.getElementById('btn-stop').disabled = false;
                    this.visualize(); 
                }).catch(e => alert("マイクへのアクセスが拒否されました"));
            },

            stopMic: function() {
                if(this.micSrc) this.micSrc.disconnect();
                cancelAnimationFrame(this.animId);
                
                const detectedHz = Math.floor(Math.random() * 200 + 200); 
                const diff = Math.abs(this.elements.guard.freq - detectedHz);
                const syncRate = Math.max(0, 100 - (diff / 5));

                document.getElementById('voice-comment').innerHTML = `
                    あなたの声：<span class="font-mono text-teal-300">${detectedHz} Hz</span><br>
                    守護周波数との同調率：<span class="font-bold text-yellow-300 text-lg">${syncRate.toFixed(1)}%</span>
                `;
                
                this.showStep('step4');
                this.drawRadar(syncRate);
            },

            drawGridOnly: function() {
                const canvas = document.getElementById('visualizer');
                const c = canvas.getContext('2d');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                
                c.fillStyle = '#02040a';
                c.fillRect(0, 0, canvas.width, canvas.height);
                this.drawGrid(c, canvas.width, canvas.height);
            },

            visualize: function() {
                const canvas = document.getElementById('visualizer');
                const c = canvas.getContext('2d');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                
                const bufferLength = this.analyzer.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    this.animId = requestAnimationFrame(draw);
                    this.analyzer.getByteTimeDomainData(dataArray);
                    
                    c.fillStyle = '#02040a';
                    c.fillRect(0, 0, canvas.width, canvas.height);
                    
                    this.drawGrid(c, canvas.width, canvas.height);

                    c.lineWidth = 2;
                    c.strokeStyle = '#facc15'; 
                    c.shadowBlur = 4;
                    c.shadowColor = '#facc15';
                    
                    c.beginPath();
                    const sliceWidth = canvas.width / bufferLength;
                    let x = 0;
                    
                    let maxAmp = 0;

                    for(let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * canvas.height / 2;
                        
                        const amp = Math.abs(dataArray[i] - 128);
                        if(amp > maxAmp) maxAmp = amp;

                        if(i===0) c.moveTo(x, y); else c.lineTo(x, y);
                        x += sliceWidth;
                    }
                    c.lineTo(canvas.width, canvas.height/2);
                    c.stroke();
                };
                draw();
            },

            drawGrid: function(c, w, h) {
                c.lineWidth = 1;
                c.strokeStyle = 'rgba(148, 163, 184, 0.15)'; 
                c.shadowBlur = 0;
                
                c.font = "10px monospace";
                c.fillStyle = "rgba(148, 163, 184, 0.5)";
                c.textAlign = "right";

                const hStep = h / 4;
                for(let i=0; i<=4; i++) {
                    const y = i * hStep;
                    c.beginPath(); c.moveTo(0, y); c.lineTo(w, y); c.stroke();
                    
                    let val = (1 - (i * 0.5)).toFixed(1);
                    if(i === 0) val = "+1.0";
                    if(i === 4) val = "-1.0";
                    if(i !== 2) { 
                        c.fillText(val, 40, y + 4); 
                    }
                }

                c.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                c.beginPath(); c.moveTo(0, h/2); c.lineTo(w, h/2); c.stroke();
                c.fillText("0.0", 40, h/2 - 4);

                c.strokeStyle = 'rgba(148, 163, 184, 0.15)';
                c.textAlign = "center";
                const wStep = w / 8;
                for(let i=1; i<8; i++) {
                    const x = i * wStep;
                    c.beginPath(); c.moveTo(x, 0); c.lineTo(x, h); c.stroke();
                }
            },

            drawRadar: function(sync) {
                const ctx = document.getElementById('radarChart').getContext('2d');
                Chart.defaults.color = '#94a3b8'; 
                Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';
                
                if(this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['木 (WOOD)', '火 (FIRE)', '土 (EARTH)', '金 (METAL)', '水 (WATER)'],
                        datasets: [{
                            label: 'ENERGY SYNC',
                            data: [85, 80, 90, 85, sync],
                            backgroundColor: 'rgba(250, 204, 21, 0.2)', 
                            borderColor: '#facc15', 
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#facc15'
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                angleLines: { color: 'rgba(255,255,255,0.05)' },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                pointLabels: { font: { size: 10 } },
                                min: 0, max: 100,
                                ticks: { display: false }
                            }
                        },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            },

            download: function() {
                alert("共鳴ファイル(.wav)のダウンロードを開始します...");
                const a = document.createElement("a");
                a.href = "#"; a.download = "astro_resonance.wav"; a.click();
            },

            showStep: function(id) {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                el.classList.add('step-anim');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
