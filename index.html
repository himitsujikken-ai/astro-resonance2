<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Resonance | é‡å­å‘¨æ³¢æ•°èª¿å¾‹ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 40%, #020617 100%);
            font-family: 'Noto Sans JP', sans-serif;
            color: #e2e8f0;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        @keyframes floatUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .anim-entry { animation: floatUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }

        .scope-screen {
            background: #000;
            background-image: 
                linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* æœ€çµ‚æ³¢å½¢è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .final-wave-container {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid #14b8a6;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(20, 184, 166, 0.1);
        }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°éŒ²éŸ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        #recording-float {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid #ec4899;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(236, 72, 153, 0.3);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #recording-float.active {
            opacity: 1;
            pointer-events: auto;
        }
        .rec-pulse {
            animation: recPulse 1s ease-in-out infinite;
        }
        @keyframes recPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
    </style>
</head>
<body class="min-h-screen selection:bg-teal-500/30">

    <div class="min-h-screen flex flex-col">
        
        <header class="w-full border-b border-slate-800/60 bg-slate-950/40 backdrop-blur-md sticky top-0 z-50">
            <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full border border-teal-500/50 flex items-center justify-center bg-teal-500/10 text-teal-400 font-cinzel font-bold">
                        AR
                    </div>
                    <div class="flex flex-col leading-tight">
                        <span class="font-bold tracking-[0.15em] text-xs uppercase text-teal-500">
                            Astro Resonance
                        </span>
                        <span class="font-cinzel text-lg text-slate-100 tracking-wide">
                            Quantum Tuning System
                        </span>
                    </div>
                </div>
                <div class="hidden md:flex items-center gap-4 text-xs font-mono text-slate-500">
                    <span>SYS: ONLINE</span>
                    <span>VER: 3.2.1</span>
                </div>
            </div>
        </header>

        <main class="flex-1 w-full mx-auto max-w-5xl px-4 pt-10 pb-24">

            <div class="text-center mb-16 anim-entry">
                <p class="text-xs font-bold tracking-[0.4em] uppercase text-slate-500 mb-4">
                    Scientific Frequency Alignment
                </p>
                <h1 class="text-3xl md:text-5xl font-bold font-cinzel text-transparent bg-clip-text bg-gradient-to-r from-teal-200 via-slate-100 to-teal-200 mb-6 drop-shadow-lg">
                    é‹å‘½ã¨éŸ³å£°ã®<span class="text-teal-400">ç§‘å­¦çš„çµ±åˆ</span>
                </h1>
                <p class="text-sm md:text-base text-slate-400 leading-loose max-w-3xl mx-auto">
                    æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€<span class="text-slate-200 font-semibold">ã€Œæ™‚é–“(ç®—å‘½å­¦)ã€ã€Œç©ºé–“(ã‚«ã‚¿ã‚«ãƒ ãƒŠ)ã€ã€Œç¾è±¡(ãƒ•ãƒ¼ãƒªã‚¨è§£æ)ã€</span>ã®3ã¤ã®åº§æ¨™è»¸ã‚’çµ±åˆã™ã‚‹ä¸–ç•Œåˆã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚<br>
                    ã‚ãªãŸã®ç”Ÿä½“ã‚¨ãƒãƒ«ã‚®ãƒ¼(å£°)ã‚’æ•°å­¦çš„ã«åˆ†è§£ã—ã€é‹å‘½å¼ã‹ã‚‰å°ã‹ã‚Œã‚‹ç†æƒ³æ³¢å½¢ã¨ã®ã‚ºãƒ¬ã‚’è£œæ­£ã™ã‚‹ã€Œå…±é³´éŸ³ã€ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-16 anim-entry delay-100">
                <div class="glass-panel p-6 rounded-2xl border-t-2 border-t-blue-500/50 hover:bg-slate-800/50 transition-colors">
                    <div class="text-xs font-mono text-blue-400 mb-2">TEMPORAL COORDINATE</div>
                    <h3 class="text-lg font-bold text-slate-100 mb-3">ç®—å‘½å­¦ (Time)</h3>
                    <p class="text-xs text-slate-400 leading-relaxed text-justify">
                        ç”Ÿå¹´æœˆæ—¥ã¯å˜ãªã‚‹è¨˜å·ã§ã¯ãªãã€å¤ªé™½ã¨åœ°çƒã®ä½ç½®é–¢ä¿‚ãŒç¤ºã™ã€Œç£å ´ã€ã®è¨˜éŒ²ã§ã™ã€‚ã‚ãªãŸãŒç”Ÿã¾ã‚ŒãŸç¬é–“ã®å®‡å®™ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼é…ç½®ã‚’åº§æ¨™åŒ–ã—ã€é­‚ãŒæœ¬æ¥æŒã¤ã¹ãã€ŒåŸºæœ¬æŒ¯å‹•æ•°(Fundamental Frequency)ã€ã‚’ç®—å‡ºã—ã¾ã™ã€‚ã“ã‚ŒãŒèª¿æ•´ã®ç›®æ¨™å€¤ã¨ãªã‚Šã¾ã™ã€‚
                    </p>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-t-2 border-t-emerald-500/50 hover:bg-slate-800/50 transition-colors">
                    <div class="text-xs font-mono text-emerald-400 mb-2">SPATIAL VIBRATION</div>
                    <h3 class="text-lg font-bold text-slate-100 mb-3">ã‚«ã‚¿ã‚«ãƒ ãƒŠ (Space)</h3>
                    <p class="text-xs text-slate-400 leading-relaxed text-justify">
                        ã€Œåã¯ä½“ã‚’è¡¨ã™ã€ã¨ã„ã†è¨€è‘‰é€šã‚Šã€æ°åã®éŸ³éŸ»ã¯ç©ºé–“ã«ç‰©ç†çš„ãªæŒ¯å‹•ã‚’ä¸ãˆã¾ã™ã€‚ã‚«ã‚¿ã‚«ãƒ ãƒŠç‰©ç†å­¦ã«åŸºã¥ãã€ã‚ãªãŸã®åå‰ã®éŸ¿ãã‚’ç‰©ç†çš„ãªå‘¨æ³¢æ•°ã«å¤‰æ›ã€‚å¾Œå¤©çš„ã«ä¸ãˆã‚‰ã‚ŒãŸã€ŒéŸ³ã®è³‡è³ªã€ã‚’è§£æã—ã€å®¿å‘½ã¨ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
                    </p>
                </div>
                <div class="glass-panel p-6 rounded-2xl border-t-2 border-t-purple-500/50 hover:bg-slate-800/50 transition-colors">
                    <div class="text-xs font-mono text-purple-400 mb-2">SIGNAL PROCESSING</div>
                    <h3 class="text-lg font-bold text-slate-100 mb-3">ãƒ•ãƒ¼ãƒªã‚¨å¤‰æ› (Signal)</h3>
                    <p class="text-xs text-slate-400 leading-relaxed text-justify">
                        é«˜é€Ÿãƒ•ãƒ¼ãƒªã‚¨å¤‰æ›(FFT)ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç”¨ã„ã¦ã€å…¥åŠ›ã•ã‚ŒãŸã‚ãªãŸã®ã€Œç”Ÿå£°ã€ã‚’å‘¨æ³¢æ•°ã‚¹ãƒšã‚¯ãƒˆãƒ«ã«åˆ†è§£ã—ã¾ã™ã€‚è¤‡é›‘ãªæ³¢å½¢ã®ä¸­ã‹ã‚‰å„ªå‹¢ãªå‘¨æ³¢æ•°ã‚’ç‰¹å®šã—ã€ç®—å‘½å­¦(ç†æƒ³)ã¨ã‚«ã‚¿ã‚«ãƒ ãƒŠ(è³‡è³ª)ã¨ã®ã€Œèª¤å·®ã€ã‚’æ•°å­¦çš„ã«è¨ˆç®—ã—ã¾ã™ã€‚
                    </p>
                </div>
            </div>

            <div id="step1" class="glass-panel rounded-3xl p-8 mb-10 anim-entry delay-200 transition-all duration-500">
                <div class="flex items-center gap-4 mb-8">
                    <div class="h-8 w-8 rounded bg-slate-800 text-slate-400 flex items-center justify-center font-mono text-sm border border-slate-700">01</div>
                    <h2 class="text-xl font-bold text-slate-100">è§£æãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼å…¥åŠ›</h2>
                </div>
                
                <div class="grid gap-8 md:grid-cols-2">
                    <div>
                        <label class="block text-xs font-bold tracking-wider text-slate-500 mb-3">NAME (HIRAGANA)</label>
                        <input type="text" id="inp-name" value="ãŸãªã‹ãŸã‚ã†" placeholder="ã‚ã‹ã•" 
                            class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-slate-200 focus:outline-none focus:border-teal-500/50 focus:ring-1 focus:ring-teal-500/50 transition-all font-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold tracking-wider text-slate-500 mb-3">BIRTH DATE</label>
                        <input type="date" id="inp-date" value="1995-08-08" 
                            class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-slate-200 focus:outline-none focus:border-teal-500/50 focus:ring-1 focus:ring-teal-500/50 transition-all font-lg">
                    </div>
                </div>

                <button id="btn-calc" onclick="app.calculate()" 
                    class="mt-8 w-full bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-teal-500/50 active:scale-95">
                    å‘¨æ³¢æ•°ã‚’è¨ˆç®—ã™ã‚‹
                </button>
            </div>

            <div id="step2" class="glass-panel rounded-3xl p-8 mb-10 hidden">
                <div class="flex items-center gap-4 mb-8">
                    <div class="h-8 w-8 rounded bg-slate-800 text-slate-400 flex items-center justify-center font-mono text-sm border border-slate-700">02</div>
                    <h2 class="text-xl font-bold text-slate-100">ç®—å‡ºã•ã‚ŒãŸå‘¨æ³¢æ•°</h2>
                </div>

                <div class="grid gap-6 md:grid-cols-3">
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6">
                        <div class="text-xs font-mono text-blue-400 mb-2">å®ˆè­·å‘¨æ³¢æ•°</div>
                        <div id="out-guard" class="text-3xl font-bold text-blue-300 font-mono">---</div>
                        <div class="text-xs text-slate-500 mt-2">Guardian Frequency</div>
                    </div>
                    <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
                        <div class="text-xs font-mono text-emerald-400 mb-2">ã‚«ã‚¿ã‚«ãƒ ãƒŠå‘¨æ³¢æ•°</div>
                        <div id="out-kata" class="text-3xl font-bold text-emerald-300 font-mono">---</div>
                        <div class="text-xs text-slate-500 mt-2">Katakamuna Frequency</div>
                    </div>
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6">
                        <div class="text-xs font-mono text-purple-400 mb-2">è£œæ­£å‘¨æ³¢æ•°</div>
                        <div id="out-corr" class="text-3xl font-bold text-purple-300 font-mono">---</div>
                        <div class="text-xs text-slate-500 mt-2">Correction Frequency</div>
                    </div>
                </div>

                <button id="btn-startrec" onclick="app.startRecording()" 
                    class="mt-8 w-full bg-gradient-to-r from-pink-600 to-pink-500 hover:from-pink-500 hover:to-pink-400 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-pink-500/50 active:scale-95">
                    ğŸ¤ éŸ³å£°ã‚’éŒ²éŸ³ã™ã‚‹ (3ç§’)
                </button>
            </div>

            <div id="recording-float">
                <div class="text-center">
                    <div class="mb-6 rec-pulse">
                        <div class="w-20 h-20 mx-auto rounded-full bg-pink-500/20 border-2 border-pink-500 flex items-center justify-center">
                            <div class="text-4xl">ğŸ¤</div>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-pink-300 mb-2">éŒ²éŸ³ä¸­...</div>
                    <div class="text-sm text-slate-400">å£°ã‚’å‡ºã—ã¦ãã ã•ã„</div>
                    <div id="rec-timer" class="text-6xl font-mono font-bold text-white mt-6">3</div>
                </div>
            </div>

            <div id="step3" class="glass-panel rounded-3xl p-8 mb-10 hidden">
                <div class="flex items-center gap-4 mb-8">
                    <div class="h-8 w-8 rounded bg-slate-800 text-slate-400 flex items-center justify-center font-mono text-sm border border-slate-700">03</div>
                    <h2 class="text-xl font-bold text-slate-100">éŸ³å£°è§£æçµæœ</h2>
                </div>

                <div class="final-wave-container p-6 mb-6">
                    <div class="text-xs font-mono text-teal-400 mb-3">VOICE WAVEFORM</div>
                    <canvas id="canvas-final-wave" class="w-full h-32"></canvas>
                </div>

                <div class="scope-screen rounded-xl p-6 mb-6">
                    <div class="text-xs font-mono text-emerald-400 mb-3">FREQUENCY SPECTRUM (FFT)</div>
                    <canvas id="canvas-fft" class="w-full" style="height:200px;"></canvas>
                </div>

                <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6 mb-6">
                    <div class="text-xs font-mono text-purple-400 mb-2">æ¤œå‡ºã•ã‚ŒãŸä¸»è¦å‘¨æ³¢æ•°</div>
                    <div id="out-detected" class="text-4xl font-bold text-purple-300 font-mono">---</div>
                </div>

                <button onclick="app.generateTone()" 
                    class="w-full bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-purple-500/50 active:scale-95">
                    ğŸµ å…±é³´éŸ³ã‚’ç”Ÿæˆã™ã‚‹
                </button>
            </div>

            <div id="step4" class="glass-panel rounded-3xl p-8 mb-10 hidden">
                <div class="flex items-center gap-4 mb-8">
                    <div class="h-8 w-8 rounded bg-slate-800 text-slate-400 flex items-center justify-center font-mono text-sm border border-slate-700">04</div>
                    <h2 class="text-xl font-bold text-slate-100">å…±é³´éŸ³ ç”Ÿæˆå®Œäº†</h2>
                </div>

                <div class="bg-gradient-to-br from-teal-500/10 to-purple-500/10 border border-teal-500/30 rounded-xl p-8 mb-6">
                    <div class="text-center">
                        <div class="text-6xl mb-4">ğŸ¼</div>
                        <div class="text-2xl font-bold text-teal-300 mb-2">èª¿å¾‹éŸ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ</div>
                        <div class="text-sm text-slate-400">ã“ã®éŸ³ã‚’è´ãã“ã¨ã§ã€ã‚ãªãŸã®æœ¬è³ªçš„ãªæŒ¯å‹•æ•°ã«å…±é³´ã—ã¾ã™</div>
                    </div>
                </div>

                <div class="grid gap-4">
                    <button onclick="app.playTone()" 
                        class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-emerald-500/50 active:scale-95 flex items-center justify-center gap-2">
                        <span class="text-2xl">â–¶ï¸</span>
                        <span>å…±é³´éŸ³ã‚’å†ç”Ÿ</span>
                    </button>
                    
                    <button onclick="app.downloadTone()" 
                        class="w-full bg-gradient-to-r from-teal-600 to-teal-500 hover:from-teal-500 hover:to-teal-400 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 shadow-lg hover:shadow-teal-500/50 active:scale-95 flex items-center justify-center gap-2">
                        <span class="text-2xl">ğŸ’¾</span>
                        <span>WAVãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </button>
                </div>

                <div id="alarm-section" class="mt-10 pt-8 border-t border-slate-700">
                    <h3 class="text-lg font-bold text-slate-100 mb-6">ğŸ”” ç›®è¦šã¾ã—éŸ³ã®ç”Ÿæˆ</h3>
                    
                    <div id="alarm-confirm" class="text-center p-8 bg-slate-800/30 rounded-xl">
                        <p class="text-sm text-slate-400 mb-6">
                            å®ˆè­·å‘¨æ³¢æ•°ã¨ã‚·ãƒ¥ãƒ¼ãƒãƒ³å…±é³´(7.83Hz)ã‚’çµ„ã¿åˆã‚ã›ãŸã€<br>
                            è‡ªç„¶ãªç›®è¦šã‚ã‚’ä¿ƒã™2ç¨®é¡ã®ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’ç”Ÿæˆã§ãã¾ã™ã€‚
                        </p>
                        <button onclick="app.generateAlarms()" 
                            class="bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 shadow-lg hover:shadow-amber-500/50 active:scale-95">
                            ã‚¢ãƒ©ãƒ¼ãƒ éŸ³ã‚’ç”Ÿæˆã™ã‚‹
                        </button>
                    </div>

                    <div id="alarm-generating" class="hidden text-center p-8">
                        <div class="text-4xl mb-4 animate-pulse">â³</div>
                        <div class="text-lg font-bold text-amber-300">ç”Ÿæˆä¸­...</div>
                    </div>

                    <div id="alarm-ready" class="hidden">
                        <div class="grid gap-4 mt-6">
                            <div class="bg-slate-800/30 rounded-xl p-6">
                                <div class="flex items-start gap-4 mb-4">
                                    <div class="text-3xl">ğŸŒ™</div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-slate-100 mb-2">ãƒ‘ã‚¿ãƒ¼ãƒ³1: é™ã‹ãªå‘¼å¸</h4>
                                        <p class="text-xs text-slate-400">
                                            20ç§’ã‹ã‘ã¦éå¸¸ã«ç·©ã‚„ã‹ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã€‚æºã‚‰ãã®ã‚ã‚‹å€éŸ³æ§‹æˆã§ã€
                                            æ·±ã„ç¡çœ ã‹ã‚‰è‡ªç„¶ã«æ„è­˜ãŒæµ®ä¸Šã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
                                        </p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="app.playAlarm(1)" 
                                        class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-lg transition-all text-sm">
                                        â–¶ï¸ è©¦è´
                                    </button>
                                    <button onclick="app.downloadAlarm(1)" 
                                        class="bg-amber-600 hover:bg-amber-500 text-white py-2 px-4 rounded-lg transition-all text-sm">
                                        ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </div>

                            <div class="bg-slate-800/30 rounded-xl p-6">
                                <div class="flex items-start gap-4 mb-4">
                                    <div class="text-3xl">ğŸŒ…</div>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-slate-100 mb-2">ãƒ‘ã‚¿ãƒ¼ãƒ³2: æœã®å…‰</h4>
                                        <p class="text-xs text-slate-400">
                                            25ç§’ã‹ã‘ã¦æ¥µã‚ã¦ç·©ã‚„ã‹ã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã€‚ä¸­é«˜åŸŸã®å€éŸ³ãŒå¾ã€…ã«å¢—ã—ã€
                                            ã‚«ãƒ¼ãƒ†ãƒ³è¶Šã—ã®æœæ—¥ã®ã‚ˆã†ã«ã€æ˜ã‚‹ã•ãŒå¢—ã—ã¦ã„ãæ„Ÿè¦šã‚’éŸ³ã§å†ç¾ã—ã¦ã„ã¾ã™ã€‚
                                        </p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <button onclick="app.playAlarm(2)" 
                                        class="bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-lg transition-all text-sm">
                                        â–¶ï¸ è©¦è´
                                    </button>
                                    <button onclick="app.downloadAlarm(2)" 
                                        class="bg-amber-600 hover:bg-amber-500 text-white py-2 px-4 rounded-lg transition-all text-sm">
                                        ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const app = {
            audioContext: null,
            analyser: null,
            mediaRecorder: null,
            recordedChunks: [],
            voiceBuffer: null,
            generatedTone: null,
            alarmPattern1: null,
            alarmPattern2: null,
            currentSource: null,
            isAudioInitialized: false,

            elements: {
                guard: { freq: 0 },
                kata: { freq: 0 },
                corr: { freq: 0 },
                detected: { freq: 0 }
            },

            // â˜… éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å¾Œã«å‘¼ã°ã‚Œã‚‹ï¼‰
            initAudio: function() {
                if (this.isAudioInitialized) return Promise.resolve();
                
                console.log('ğŸµ Initializing Audio Context...');
                
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.audioContext = new AudioContextClass();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 4096;
                    this.isAudioInitialized = true;
                    
                    console.log('âœ… Audio Context initialized');
                    return Promise.resolve();
                } catch (e) {
                    console.error('âŒ Failed to initialize Audio Context:', e);
                    alert('éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚');
                    return Promise.reject(e);
                }
            },

            init: function() {
                console.log('ğŸŸ¢ App initialized');
                // åˆæœŸåŒ–æ™‚ã«ã¯AudioContextã‚’ä½œæˆã—ãªã„ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
            },

            calculate: function() {
                console.log('ğŸ“Š Calculating frequencies...');
                
                const name = document.getElementById('inp-name').value;
                const dateStr = document.getElementById('inp-date').value;
                
                if (!name || !dateStr) {
                    alert('åå‰ã¨ç”Ÿå¹´æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const birthDate = new Date(dateStr);
                const dayOfYear = Math.floor((birthDate - new Date(birthDate.getFullYear(), 0, 0)) / 86400000);
                
                // å®ˆè­·å‘¨æ³¢æ•° (åŸºç¤æŒ¯å‹•æ•°)
                const guardFreq = 200 + (dayOfYear % 100) * 2;
                
                // ã‚«ã‚¿ã‚«ãƒ ãƒŠå‘¨æ³¢æ•°
                let kataSum = 0;
                const kataMap = {
                    'ã‚':1,'ã„':2,'ã†':3,'ãˆ':4,'ãŠ':5,
                    'ã‹':6,'ã':7,'ã':8,'ã‘':9,'ã“':10,
                    'ã•':11,'ã—':12,'ã™':13,'ã›':14,'ã':15,
                    'ãŸ':16,'ã¡':17,'ã¤':18,'ã¦':19,'ã¨':20,
                    'ãª':21,'ã«':22,'ã¬':23,'ã­':24,'ã®':25,
                    'ã¯':26,'ã²':27,'ãµ':28,'ã¸':29,'ã»':30,
                    'ã¾':31,'ã¿':32,'ã‚€':33,'ã‚':34,'ã‚‚':35,
                    'ã‚„':36,'ã‚†':37,'ã‚ˆ':38,
                    'ã‚‰':39,'ã‚Š':40,'ã‚‹':41,'ã‚Œ':42,'ã‚':43,
                    'ã‚':44,'ã‚’':45,'ã‚“':46
                };
                for (let c of name) {
                    kataSum += (kataMap[c] || 0);
                }
                const kataFreq = 150 + (kataSum % 80) * 3;
                
                // è£œæ­£å‘¨æ³¢æ•°
                const corrFreq = Math.abs(guardFreq - kataFreq);

                this.elements.guard.freq = guardFreq;
                this.elements.kata.freq = kataFreq;
                this.elements.corr.freq = corrFreq;

                document.getElementById('out-guard').textContent = guardFreq.toFixed(2) + ' Hz';
                document.getElementById('out-kata').textContent = kataFreq.toFixed(2) + ' Hz';
                document.getElementById('out-corr').textContent = corrFreq.toFixed(2) + ' Hz';

                this.showStep('step2');
            },

            startRecording: async function() {
                console.log('ğŸ¤ Starting recording...');
                
                // â˜… éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã§ï¼‰
                try {
                    await this.initAudio();
                } catch (e) {
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        } 
                    });
                    
                    console.log('âœ… Microphone access granted');

                    // ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤º
                    const floatWin = document.getElementById('recording-float');
                    floatWin.classList.add('active');

                    // MediaRecorderã§éŒ²éŸ³
                    this.recordedChunks = [];
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            this.recordedChunks.push(e.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        console.log('ğŸ›‘ Recording stopped');
                        stream.getTracks().forEach(track => track.stop());
                        
                        const blob = new Blob(this.recordedChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        
                        reader.onload = async () => {
                            try {
                                const audioBuffer = await this.audioContext.decodeAudioData(reader.result);
                                this.voiceBuffer = audioBuffer;
                                console.log('âœ… Audio decoded');
                                this.analyzeVoice();
                            } catch (e) {
                                console.error('âŒ Failed to decode audio:', e);
                                alert('éŸ³å£°ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                            }
                        };
                        
                        reader.readAsArrayBuffer(blob);
                    };

                    this.mediaRecorder.start();
                    console.log('ğŸ”´ Recording started');

                    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
                    let countdown = 3;
                    const timerEl = document.getElementById('rec-timer');
                    const interval = setInterval(() => {
                        countdown--;
                        timerEl.textContent = countdown;
                        if (countdown === 0) {
                            clearInterval(interval);
                            this.mediaRecorder.stop();
                            floatWin.classList.remove('active');
                        }
                    }, 1000);

                } catch (err) {
                    console.error('âŒ Microphone access error:', err);
                    
                    if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
                    } else if (err.name === 'NotFoundError') {
                        alert('ãƒã‚¤ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒã‚¤ã‚¯ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    } else {
                        alert('éŒ²éŸ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¨ãƒ©ãƒ¼: ' + err.message);
                    }
                }
            },

            analyzeVoice: function() {
                console.log('ğŸ”¬ Analyzing voice...');
                
                if (!this.voiceBuffer) {
                    console.error('âŒ No voice buffer');
                    return;
                }

                const rawData = this.voiceBuffer.getChannelData(0);
                
                // æ³¢å½¢æç”»
                const canvasWave = document.getElementById('canvas-final-wave');
                const ctxWave = canvasWave.getContext('2d');
                canvasWave.width = canvasWave.offsetWidth;
                canvasWave.height = canvasWave.offsetHeight;
                
                ctxWave.clearRect(0, 0, canvasWave.width, canvasWave.height);
                ctxWave.strokeStyle = '#14b8a6';
                ctxWave.lineWidth = 2;
                ctxWave.beginPath();
                
                const step = Math.ceil(rawData.length / canvasWave.width);
                for (let i = 0; i < canvasWave.width; i++) {
                    const sample = rawData[i * step];
                    const y = (sample * 0.8 + 1) * canvasWave.height / 2;
                    if (i === 0) ctxWave.moveTo(i, y);
                    else ctxWave.lineTo(i, y);
                }
                ctxWave.stroke();

                // FFTè§£æ
                const fftSize = 4096;
                const fft = new Float32Array(fftSize);
                for (let i = 0; i < Math.min(fftSize, rawData.length); i++) {
                    fft[i] = rawData[i];
                }
                
                // çª“é–¢æ•°ï¼ˆãƒãƒŸãƒ³ã‚°çª“ï¼‰
                for (let i = 0; i < fftSize; i++) {
                    fft[i] *= 0.54 - 0.46 * Math.cos(2 * Math.PI * i / fftSize);
                }

                // FFTè¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆ - å®Ÿéš›ã«ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨æ¨å¥¨ï¼‰
                const magnitude = new Float32Array(fftSize / 2);
                for (let k = 0; k < fftSize / 2; k++) {
                    let real = 0, imag = 0;
                    for (let n = 0; n < fftSize; n++) {
                        const angle = -2 * Math.PI * k * n / fftSize;
                        real += fft[n] * Math.cos(angle);
                        imag += fft[n] * Math.sin(angle);
                    }
                    magnitude[k] = Math.sqrt(real * real + imag * imag);
                }

                // ãƒ”ãƒ¼ã‚¯æ¤œå‡º
                const sampleRate = this.voiceBuffer.sampleRate;
                let maxMag = 0, maxIdx = 0;
                const minFreq = 80, maxFreq = 500;
                const minIdx = Math.floor(minFreq * fftSize / sampleRate);
                const maxIdx = Math.floor(maxFreq * fftSize / sampleRate);
                
                for (let i = minIdx; i < maxIdx; i++) {
                    if (magnitude[i] > maxMag) {
                        maxMag = magnitude[i];
                        maxIdx = i;
                    }
                }

                const detectedFreq = maxIdx * sampleRate / fftSize;
                this.elements.detected.freq = detectedFreq;
                
                document.getElementById('out-detected').textContent = detectedFreq.toFixed(2) + ' Hz';

                // FFTæç”»
                const canvasFFT = document.getElementById('canvas-fft');
                const ctxFFT = canvasFFT.getContext('2d');
                canvasFFT.width = canvasFFT.offsetWidth;
                canvasFFT.height = 200;
                
                ctxFFT.clearRect(0, 0, canvasFFT.width, canvasFFT.height);
                
                // ã‚°ãƒªãƒƒãƒ‰
                ctxFFT.strokeStyle = 'rgba(16, 185, 129, 0.1)';
                ctxFFT.lineWidth = 1;
                for (let i = 0; i <= 10; i++) {
                    const y = i * canvasFFT.height / 10;
                    ctxFFT.beginPath();
                    ctxFFT.moveTo(0, y);
                    ctxFFT.lineTo(canvasFFT.width, y);
                    ctxFFT.stroke();
                }

                // ã‚¹ãƒšã‚¯ãƒˆãƒ«æç”»
                ctxFFT.strokeStyle = '#10b981';
                ctxFFT.fillStyle = 'rgba(16, 185, 129, 0.3)';
                ctxFFT.lineWidth = 1.5;
                ctxFFT.beginPath();
                ctxFFT.moveTo(0, canvasFFT.height);
                
                const maxMagnitude = Math.max(...magnitude);
                for (let i = 0; i < canvasFFT.width; i++) {
                    const idx = Math.floor(i * magnitude.length / canvasFFT.width);
                    const normalized = magnitude[idx] / maxMagnitude;
                    const y = canvasFFT.height - (normalized * canvasFFT.height * 0.9);
                    ctxFFT.lineTo(i, y);
                }
                
                ctxFFT.lineTo(canvasFFT.width, canvasFFT.height);
                ctxFFT.closePath();
                ctxFFT.fill();
                ctxFFT.stroke();

                console.log('âœ… Voice analysis complete');
                this.showStep('step3');
            },

            generateTone: function() {
                console.log('ğŸµ Generating resonance tone...');

                const sampleRate = 44100;
                const duration = 30; // 30ç§’
                const samples = sampleRate * duration;
                const buffer = new Float32Array(samples);

                const guardFreq = this.elements.guard.freq;
                const kataFreq = this.elements.kata.freq;
                const corrFreq = this.elements.corr.freq;
                const schumannFreq = 7.83;

                for (let i = 0; i < samples; i++) {
                    const t = i / sampleRate;
                    
                    // å®ˆè­·å‘¨æ³¢æ•°ï¼ˆåŸºéŸ³ï¼‰
                    const guard = Math.sin(2 * Math.PI * guardFreq * t) * 0.4;
                    
                    // ã‚«ã‚¿ã‚«ãƒ ãƒŠå‘¨æ³¢æ•°ï¼ˆå€éŸ³ï¼‰
                    const kata = Math.sin(2 * Math.PI * kataFreq * t) * 0.3;
                    
                    // è£œæ­£å‘¨æ³¢æ•°ï¼ˆèª¿æ•´éŸ³ï¼‰
                    const corr = Math.sin(2 * Math.PI * corrFreq * t) * 0.2;
                    
                    // ã‚·ãƒ¥ãƒ¼ãƒãƒ³å…±é³´ï¼ˆåœ°çƒã®åŸºæœ¬å‘¨æ³¢æ•°ï¼‰
                    const schumann = Math.sin(2 * Math.PI * schumannFreq * t) * 0.1;
                    
                    // åˆæˆ
                    buffer[i] = guard + kata + corr + schumann;
                }

                this.generatedTone = buffer;
                console.log('âœ… Tone generated');
                
                this.showStep('step4');
            },

            playTone: async function() {
                console.log('â–¶ï¸ Playing tone...');
                
                // â˜… éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ï¼ˆå†ç”Ÿæ™‚ã«ã‚‚ç¢ºèªï¼‰
                try {
                    await this.initAudio();
                } catch (e) {
                    return;
                }

                if (!this.generatedTone) {
                    console.error('âŒ No tone generated');
                    return;
                }

                // æ—¢å­˜ã®å†ç”Ÿã‚’åœæ­¢
                if (this.currentSource) {
                    try {
                        this.currentSource.stop();
                    } catch (e) {
                        // ã™ã§ã«åœæ­¢ã—ã¦ã„ã‚‹å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
                    }
                }

                try {
                    // AudioContextã‚’å†é–‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    const audioBuffer = this.audioContext.createBuffer(1, this.generatedTone.length, 44100);
                    audioBuffer.getChannelData(0).set(this.generatedTone);

                    const source = this.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(this.audioContext.destination);
                    source.start(0);
                    
                    this.currentSource = source;
                    console.log('âœ… Playback started');

                    source.onended = () => {
                        console.log('â¹ï¸ Playback ended');
                        this.currentSource = null;
                    };
                } catch (e) {
                    console.error('âŒ Playback error:', e);
                    alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                }
            },

            playAlarm: async function(pattern) {
                console.log(`â–¶ï¸ Playing alarm pattern ${pattern}...`);
                
                // â˜… éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–
                try {
                    await this.initAudio();
                } catch (e) {
                    return;
                }

                let buffer;
                if (pattern === 1) {
                    if (!this.alarmPattern1) this.alarmPattern1 = this.generateAlarmPattern1();
                    buffer = this.alarmPattern1;
                } else {
                    if (!this.alarmPattern2) this.alarmPattern2 = this.generateAlarmPattern2();
                    buffer = this.alarmPattern2;
                }

                // æ—¢å­˜ã®å†ç”Ÿã‚’åœæ­¢
                if (this.currentSource) {
                    try {
                        this.currentSource.stop();
                    } catch (e) {}
                }

                try {
                    // AudioContextã‚’å†é–‹
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    const audioBuffer = this.audioContext.createBuffer(1, buffer.length, 44100);
                    audioBuffer.getChannelData(0).set(buffer);

                    const source = this.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(this.audioContext.destination);
                    source.start(0);
                    
                    this.currentSource = source;
                    
                    source.onended = () => {
                        this.currentSource = null;
                    };
                } catch (e) {
                    console.error('âŒ Alarm playback error:', e);
                    alert('å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                }
            },

            downloadTone: function() {
                console.log('ğŸ’¾ Downloading tone...');
                
                if (!this.generatedTone) {
                    console.error('âŒ No tone to download');
                    return;
                }

                const wavBytes = this.encodeWAV(this.generatedTone, 44100);
                const blob = new Blob([wavBytes], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ResonanceTone_${this.elements.guard.freq}Hz.wav`;
                a.click();
                
                console.log('âœ… Download started');
            },

            encodeWAV: function(samples, sampleRate) {
                const buffer = new ArrayBuffer(44 + samples.length * 2);
                const view = new DataView(buffer);

                const writeString = (offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                writeString(0, 'RIFF');
                view.setUint32(4, 36 + samples.length * 2, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                writeString(36, 'data');
                view.setUint32(40, samples.length * 2, true);

                let offset = 44;
                for (let i = 0; i < samples.length; i++) {
                    const s = Math.max(-1, Math.min(1, samples[i]));
                    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true); 
                    offset += 2;
                }
                return view;
            },

            generateAlarms: function() {
                console.log('ğŸ”” Generating alarm sounds...');
                
                document.getElementById('alarm-confirm').classList.add('hidden');
                document.getElementById('alarm-generating').classList.remove('hidden');
                
                setTimeout(() => {
                    this.alarmPattern1 = this.generateAlarmPattern1();
                    this.alarmPattern2 = this.generateAlarmPattern2();
                    
                    document.getElementById('alarm-generating').classList.add('hidden');
                    document.getElementById('alarm-ready').classList.remove('hidden');
                    
                    console.log('âœ… Alarm sounds generated');
                }, 2000);
            },

            generateAlarmPattern1: function() {
                const sampleRate = 44100;
                const duration = 30;
                const samples = sampleRate * duration;
                const buffer = new Float32Array(samples);
                
                const guardFreq = this.elements.guard.freq;
                const schumannFreq = 7.83;
                const fadeInTime = 20;
                
                for (let i = 0; i < samples; i++) {
                    const t = i / sampleRate;
                    
                    let envelope = 0;
                    if (t < fadeInTime) {
                        envelope = Math.pow(t / fadeInTime, 2.5) * 0.001;
                        envelope = Math.min(envelope, 0.3);
                    } else {
                        envelope = 0.3;
                    }
                    
                    const vibrato = Math.sin(2 * Math.PI * 0.05 * t) * 0.002;
                    const tremolo = Math.sin(2 * Math.PI * 0.08 * t) * 0.1 + 1;
                    
                    const fundamental = Math.sin(2 * Math.PI * (guardFreq + vibrato * guardFreq) * t);
                    const harmonic2 = Math.sin(2 * Math.PI * (guardFreq * 2) * t) * 0.3;
                    const harmonic3 = Math.sin(2 * Math.PI * (guardFreq * 3) * t) * 0.15;
                    const schumann = Math.sin(2 * Math.PI * schumannFreq * t) * 0.2;
                    
                    buffer[i] = (fundamental * 0.5 + harmonic2 + harmonic3 + schumann) * envelope * tremolo;
                }
                
                console.log('ğŸ”” Pattern 1 generated');
                return buffer;
            },

            generateAlarmPattern2: function() {
                const sampleRate = 44100;
                const duration = 30;
                const samples = sampleRate * duration;
                const buffer = new Float32Array(samples);
                
                const guardFreq = this.elements.guard.freq;
                const schumannFreq = 7.83;
                const fadeInTime = 25;
                
                for (let i = 0; i < samples; i++) {
                    const t = i / sampleRate;
                    
                    let envelope = 0;
                    if (t < fadeInTime) {
                        envelope = Math.pow(t / fadeInTime, 3) * 0.0005;
                        envelope = Math.min(envelope, 0.35);
                    } else {
                        envelope = 0.35;
                    }
                    
                    const brightness = Math.min(t / fadeInTime, 1);
                    
                    const fundamental = Math.sin(2 * Math.PI * guardFreq * t);
                    const harmonic2 = Math.sin(2 * Math.PI * (guardFreq * 2) * t) * 0.25 * brightness;
                    const harmonic3 = Math.sin(2 * Math.PI * (guardFreq * 3) * t) * 0.15 * brightness;
                    const harmonic4 = Math.sin(2 * Math.PI * (guardFreq * 4) * t) * 0.1 * brightness;
                    const harmonic5 = Math.sin(2 * Math.PI * (guardFreq * 5) * t) * 0.05 * brightness;
                    const schumann = Math.sin(2 * Math.PI * schumannFreq * t) * 0.15;
                    const chorus = Math.sin(2 * Math.PI * (guardFreq * 1.002) * t) * 0.1 * brightness;
                    
                    buffer[i] = (fundamental * 0.45 + harmonic2 + harmonic3 + harmonic4 + harmonic5 + schumann + chorus) * envelope;
                }
                
                console.log('ğŸŒ… Pattern 2 generated');
                return buffer;
            },

            downloadAlarm: function(pattern) {
                let buffer, filename;
                
                if (pattern === 1) {
                    if (!this.alarmPattern1) this.alarmPattern1 = this.generateAlarmPattern1();
                    buffer = this.alarmPattern1;
                    filename = `Alarm_GentleBreathing_${this.elements.guard.freq}Hz.wav`;
                } else {
                    if (!this.alarmPattern2) this.alarmPattern2 = this.generateAlarmPattern2();
                    buffer = this.alarmPattern2;
                    filename = `Alarm_MorningLight_${this.elements.guard.freq}Hz.wav`;
                }
                
                const wavBytes = this.encodeWAV(buffer, 44100);
                const blob = new Blob([wavBytes], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                console.log(`âœ… Downloaded: ${filename}`);
            },

            showStep: function(id) {
                const el = document.getElementById(id);
                if (!el) {
                    console.error('Element not found:', id);
                    return;
                }
                el.classList.remove('hidden');
                el.classList.add('anim-entry');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        window.onload = () => {
            console.log('ğŸŸ¢ Page loaded');
            app.init();
        };
    </script>
</body>
</html>
