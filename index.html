<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Resonance | 音霊フーリエ解析</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">

    <style>
        body {
            /* forecast.html と同じ深淵な背景グラデーション */
            background: radial-gradient(circle at top, #1b2340 0, #050816 45%, #02010d 100%);
            font-family: 'Noto Sans JP', sans-serif;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        /* 浮遊感のあるアニメーション */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .step-anim { animation: fadeUp 0.6s ease forwards; }
        
        /* キャンバス用コンテナ */
        .scope-container {
            position: relative;
            background: #02040a;
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            border: 1px solid rgba(148,163,184,0.1);
        }
    </style>
</head>
<body class="min-h-screen text-slate-100 selection:bg-yellow-400/30">

    <div class="min-h-screen flex flex-col">
        
        <header class="w-full border-b border-slate-800/60 bg-slate-950/20 backdrop-blur-sm sticky top-0 z-50">
            <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="h-9 w-9 rounded-full border border-yellow-400/60 flex items-center justify-center text-xs tracking-widest bg-yellow-400/10 text-yellow-300">
                        響
                    </div>
                    <div class="flex flex-col leading-tight">
                        <span class="font-semibold tracking-[0.2em] text-[10px] uppercase text-yellow-300/80">
                            Astro Resonance
                        </span>
                        <span class="font-cinzel font-semibold text-slate-50 text-lg tracking-wide">
                            Fourier Tuning
                        </span>
                    </div>
                </div>
                <div class="hidden md:block text-xs text-slate-500 tracking-widest">
                    V2.0 // PHASE: HARMONY
                </div>
            </div>
        </header>

        <main class="flex-1">
            <div class="mx-auto max-w-4xl px-4 pt-10 pb-20">

                <div class="text-center mb-12">
                    <p class="text-xs tracking-[0.35em] uppercase text-slate-400 mb-3">
                        Quantum Frequency Alignment
                    </p>
                    <h1 class="text-3xl md:text-4xl font-semibold mb-6 font-cinzel text-slate-100">
                        運命周波数の<span class="text-yellow-300">調律</span>
                    </h1>
                    <p class="text-sm text-slate-400 leading-relaxed max-w-2xl mx-auto">
                        算命学で導き出された「時間」の座標を、フーリエ変換により「音（周波数）」へ変換。<br>
                        不足している波動を補い、空間と共鳴させるためのシステムです。
                    </p>
                </div>

                <div class="grid gap-4 md:grid-cols-3 mb-16">
                    <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-5 hover:border-slate-600 transition-colors">
                        <div class="text-[10px] tracking-widest text-slate-500 mb-2">TIME CALCULATION</div>
                        <h3 class="text-base font-semibold text-slate-200 mb-2 border-b border-slate-800 pb-2">算命学</h3>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            生年月日から、あなたの魂が持つ固有の「エネルギー座標」を算出。運命の設計図をデコードします。
                        </p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-5 hover:border-slate-600 transition-colors">
                        <div class="text-[10px] tracking-widest text-slate-500 mb-2">MATH TRANSLATION</div>
                        <h3 class="text-base font-semibold text-slate-200 mb-2 border-b border-slate-800 pb-2">フーリエ変換</h3>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            運命という抽象概念を「周波数(Hz)」に変換。あなたの声の波形を数学的に分解し、欠落部分を特定します。
                        </p>
                    </div>
                    <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-5 hover:border-slate-600 transition-colors">
                        <div class="text-[10px] tracking-widest text-slate-500 mb-2">SPACE PHYSICS</div>
                        <h3 class="text-base font-semibold text-slate-200 mb-2 border-b border-slate-800 pb-2">カタカムナ</h3>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            算出された周波数を、空間そのものを整える「響き（音霊）」として出力し、現実に物理的干渉を行います。
                        </p>
                    </div>
                </div>

                <div id="step1" class="step-anim rounded-3xl border border-slate-800 bg-slate-900/50 p-6 md:p-8 mb-8 shadow-lg">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-slate-800 text-slate-300 text-xs px-2 py-1 rounded">STEP 01</span>
                        <h2 class="text-lg font-semibold text-slate-100">解析データの入力</h2>
                    </div>
                    
                    <div class="grid gap-6 md:grid-cols-2">
                        <div>
                            <label class="block text-xs tracking-wider text-slate-400 mb-2">NAME (HIRAGANA)</label>
                            <input type="text" id="inp-name" value="たなかたろう" placeholder="あかさ" 
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-yellow-400/50 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs tracking-wider text-slate-400 mb-2">BIRTH DATE</label>
                            <input type="date" id="inp-date" value="1995-08-08" 
                                class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-yellow-400/50 transition-colors">
                        </div>
                    </div>

                    <div class="mt-8">
                        <button onclick="app.analyze()" 
                            class="w-full md:w-auto md:px-12 py-3 rounded-full bg-slate-100 text-slate-900 font-semibold text-sm hover:bg-yellow-300 transition-colors shadow-[0_0_20px_rgba(255,255,255,0.1)]">
                            運命周波数を解析する (Initialize)
                        </button>
                    </div>
                </div>

                <div id="step2" class="hidden rounded-3xl border border-yellow-400/30 bg-slate-900/60 p-6 md:p-8 mb-8 shadow-[0_0_30px_rgba(250,204,21,0.05)]">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-yellow-400/10 text-yellow-300 border border-yellow-400/20 text-xs px-2 py-1 rounded">STEP 02</span>
                        <h2 class="text-lg font-semibold text-yellow-100">守護周波数の生成</h2>
                    </div>

                    <div id="sanmei-result" class="mb-6 p-4 rounded-xl bg-slate-950/50 border border-slate-800/50"></div>

                    <p class="text-sm text-slate-300 mb-6 leading-relaxed">
                        解析完了。あなたのエネルギーバランスを整える<span class="text-yellow-300 font-semibold">「守護神サウンド」</span>を生成しました。<br>
                        下の波形モニタを確認しながら、音を再生してください。
                    </p>

                    <div class="scope-container h-48 md:h-64 mb-6 w-full">
                        <canvas id="visualizer" class="w-full h-full block"></canvas>
                        <div class="absolute top-2 right-3 text-[10px] text-yellow-500 font-mono opacity-70">
                            GAIN: <span id="gain-val">0.0</span> dB
                        </div>
                    </div>

                    <div class="text-center">
                        <button id="btn-play" onclick="app.playSound()" 
                            class="w-full md:w-auto px-10 py-3 rounded-full bg-yellow-400 text-slate-950 font-bold text-sm hover:bg-yellow-300 transition-colors shadow-lg shadow-yellow-400/20">
                            ▶ 音霊を再生 (Play Resonance)
                        </button>
                    </div>
                </div>

                <div id="step3" class="hidden rounded-3xl border border-fuchsia-500/30 bg-slate-900/60 p-6 md:p-8 mb-8">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="bg-fuchsia-500/10 text-fuchsia-300 border border-fuchsia-500/20 text-xs px-2 py-1 rounded">STEP 03</span>
                        <h2 class="text-lg font-semibold text-fuchsia-100">意識の同調（Vocal Sync）</h2>
                    </div>
                    
                    <p class="text-sm text-slate-300 mb-8">
                        再生される音に合わせて、声を出してください（ハミング等）。<br>
                        あなたの生体エネルギー（声）とデジタル波形を統合します。
                    </p>

                    <div class="flex gap-4">
                        <button id="btn-rec" onclick="app.startMic()" 
                            class="flex-1 py-3 rounded-full border border-fuchsia-400 text-fuchsia-300 font-semibold text-sm hover:bg-fuchsia-400 hover:text-slate-900 transition-colors">
                            ● 録音開始 (Rec)
                        </button>
                        <button id="btn-stop" onclick="app.stopMic()" disabled
                            class="flex-1 py-3 rounded-full bg-slate-800 text-slate-500 font-semibold text-sm disabled:opacity-50 enabled:bg-fuchsia-500 enabled:text-white enabled:hover:bg-fuchsia-400 transition-colors">
                            ■ 停止＆統合 (Merge)
                        </button>
                    </div>
                </div>

                <div id="step4" class="hidden rounded-3xl border border-slate-700 bg-slate-900/80 p-6 md:p-8 mb-10">
                    <div class="text-center mb-6">
                        <div class="inline-block px-3 py-1 rounded-full bg-teal-500/10 text-teal-300 border border-teal-500/20 text-xs mb-3">
                            SYNC COMPLETE
                        </div>
                        <h3 class="text-xl font-cinzel text-slate-100">共鳴・統合完了</h3>
                        <div id="voice-comment" class="mt-4 text-sm text-slate-300 leading-relaxed"></div>
                    </div>

                    <div class="relative h-64 w-full mb-8 bg-slate-950/50 rounded-xl border border-slate-800 p-2">
                        <canvas id="radarChart"></canvas>
                    </div>

                    <div class="text-center">
                        <button onclick="app.download()" 
                            class="px-8 py-3 rounded-full border border-slate-600 text-slate-300 text-sm hover:border-teal-400 hover:text-teal-300 transition-colors">
                            ↓ 共鳴ファイル(.wav)を保存
                        </button>
                    </div>
                </div>

            </div>
        </main>

        <footer class="border-t border-slate-800/80 bg-slate-950/60 text-center py-6">
            <div class="text-[10px] text-slate-600 tracking-widest uppercase">
                © 2025 Astro Resonance Fourier System
            </div>
        </footer>
    </div>

    <script>
        // --- LOGIC CORE ---
        const Logic = {
            calcElements: function(dateStr) {
                const d = new Date(dateStr);
                // 簡易ロジック
                const types = [
                    {n:"木性 (WOOD)", desc:"成長・直感", freq: 396}, 
                    {n:"火性 (FIRE)", desc:"情熱・変容", freq: 528}, 
                    {n:"土性 (EARTH)", desc:"安定・接続", freq: 639}, 
                    {n:"金性 (METAL)", desc:"改革・収穫", freq: 741}, 
                    {n:"水性 (WATER)", desc:"知性・柔軟", freq: 852}  
                ];
                const val = d.getFullYear() + d.getMonth() + d.getDate();
                const myIdx = val % 5;
                const guardIdx = (myIdx + 2) % 5; 
                return { my: types[myIdx], guard: types[guardIdx] };
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            ctx: null, analyzer: null, src: null, micSrc: null,
            isPlaying: false, animId: null, elements: null,
            
            init: function() {
                // URLパラメータ連携
                const p = new URLSearchParams(window.location.search);
                const dob = p.get('dob');
                const name = p.get('name');
                if(dob) {
                    const fmt = dob.substring(0,4)+'-'+dob.substring(4,6)+'-'+dob.substring(6,8);
                    document.getElementById('inp-date').value = fmt;
                    if(name) document.getElementById('inp-name').value = decodeURIComponent(name);
                    
                    // 自動実行の演出
                    setTimeout(() => this.analyze(), 800);
                }
            },

            analyze: function() {
                const date = document.getElementById('inp-date').value;
                if(!date) return alert("日付を入力してください");
                
                this.elements = Logic.calcElements(date);
                
                // 結果表示 (Tailwind Cards)
                const html = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-slate-900 rounded-lg p-3 border border-slate-800">
                            <div class="text-[10px] text-slate-500 mb-1">SOUL TYPE</div>
                            <div class="text-sm font-semibold text-slate-200">${this.elements.my.n}</div>
                        </div>
                        <div class="bg-yellow-400/5 rounded-lg p-3 border border-yellow-400/30">
                            <div class="text-[10px] text-yellow-500 mb-1">GUARDIAN (守護)</div>
                            <div class="text-sm font-bold text-yellow-300">${this.elements.guard.n}</div>
                        </div>
                        <div class="bg-slate-900 rounded-lg p-3 border border-slate-800">
                            <div class="text-[10px] text-slate-500 mb-1">BASE FREQ</div>
                            <div class="text-sm font-mono text-slate-200">${this.elements.guard.freq} Hz</div>
                        </div>
                    </div>
                `;
                document.getElementById('sanmei-result').innerHTML = html;
                
                this.showStep('step2');
                
                // キャンバス初期化（グリッドだけ描画）
                setTimeout(() => this.drawGridOnly(), 100);
            },

            initAudio: function() {
                if(!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyzer = this.ctx.createAnalyser();
                    this.analyzer.fftSize = 2048;
                }
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },

            playSound: function() {
                if(this.isPlaying) return;
                this.initAudio();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                const baseFreq = this.elements.guard.freq;
                osc.frequency.setValueAtTime(baseFreq, this.ctx.currentTime);
                
                gain.gain.setValueAtTime(0, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 0.5);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 5);
                
                osc.connect(gain);
                gain.connect(this.analyzer);
                gain.connect(this.ctx.destination);
                
                osc.start();
                osc.stop(this.ctx.currentTime + 5);
                
                this.isPlaying = true;
                const btn = document.getElementById('btn-play');
                btn.innerHTML = "Generating Waves...";
                btn.classList.remove('bg-yellow-400', 'text-slate-950');
                btn.classList.add('bg-slate-700', 'text-slate-300', 'cursor-not-allowed');
                
                this.visualize();

                setTimeout(() => {
                    this.isPlaying = false;
                    btn.innerHTML = "▶ 音霊を再再生";
                    btn.classList.add('bg-yellow-400', 'text-slate-950');
                    btn.classList.remove('bg-slate-700', 'text-slate-300', 'cursor-not-allowed');
                    this.showStep('step3');
                }, 4000);
            },

            startMic: function() {
                this.initAudio();
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    this.micSrc = this.ctx.createMediaStreamSource(stream);
                    this.micSrc.connect(this.analyzer);
                    
                    const btnRec = document.getElementById('btn-rec');
                    btnRec.innerHTML = "● Recording...";
                    btnRec.classList.add('animate-pulse');
                    
                    document.getElementById('btn-stop').disabled = false;
                    this.visualize(); // 可視化再開
                }).catch(e => alert("マイクへのアクセスが拒否されました"));
            },

            stopMic: function() {
                if(this.micSrc) this.micSrc.disconnect();
                cancelAnimationFrame(this.animId);
                
                const detectedHz = Math.floor(Math.random() * 200 + 200); // ダミー解析
                const diff = Math.abs(this.elements.guard.freq - detectedHz);
                const syncRate = Math.max(0, 100 - (diff / 5));

                document.getElementById('voice-comment').innerHTML = `
                    あなたの声：<span class="font-mono text-teal-300">${detectedHz} Hz</span><br>
                    守護周波数との同調率：<span class="font-bold text-yellow-300 text-lg">${syncRate.toFixed(1)}%</span>
                `;
                
                this.showStep('step4');
                this.drawRadar(syncRate);
            },

            // --- VISUALIZATION ENGINE (With Grid & Numbers) ---
            drawGridOnly: function() {
                const canvas = document.getElementById('visualizer');
                const c = canvas.getContext('2d');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                
                // 背景クリア
                c.fillStyle = '#02040a';
                c.fillRect(0, 0, canvas.width, canvas.height);
                this.drawGrid(c, canvas.width, canvas.height);
            },

            visualize: function() {
                const canvas = document.getElementById('visualizer');
                const c = canvas.getContext('2d');
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                
                const bufferLength = this.analyzer.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    this.animId = requestAnimationFrame(draw);
                    this.analyzer.getByteTimeDomainData(dataArray);
                    
                    // 背景クリア
                    c.fillStyle = '#02040a';
                    c.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // グリッド描画
                    this.drawGrid(c, canvas.width, canvas.height);

                    // 波形描画
                    c.lineWidth = 2;
                    c.strokeStyle = '#facc15'; // Yellow-400
                    c.shadowBlur = 4;
                    c.shadowColor = '#facc15';
                    
                    c.beginPath();
                    const sliceWidth = canvas.width / bufferLength;
                    let x = 0;
                    
                    let maxAmp = 0;

                    for(let i = 0; i < bufferLength; i++) {
                        const v = dataArray[i] / 128.0;
                        const y = v * canvas.height / 2;
                        
                        // 最大振幅計測（ゲイン表示用）
                        const amp = Math.abs(dataArray[i] - 128);
                        if(amp > maxAmp) maxAmp = amp;

                        if(i===0) c.moveTo(x, y); else c.lineTo(x, y);
                        x += sliceWidth;
                    }
                    c.lineTo(canvas.width, canvas.height/2);
                    c.stroke();

                    // ゲイン数値更新（演出）
                    if(this.isPlaying) {
                        const db = (maxAmp > 0) ? (20 * Math.log10(maxAmp/128)).toFixed(1) : "-Inf";
                        const displayDb = (maxAmp > 1) ? `-${(100 - maxAmp).toFixed(1)}` : "-90.0";
                        // document.getElementById('gain-val').innerText = displayDb;
                    }
                };
                draw();
            },

            // グリッドと数値を描画する関数
            drawGrid: function(c, w, h) {
                c.lineWidth = 1;
                c.strokeStyle = 'rgba(148, 163, 184, 0.15)'; // Slate-400 low opacity
                c.shadowBlur = 0;
                
                c.font = "10px monospace";
                c.fillStyle = "rgba(148, 163, 184, 0.5)";
                c.textAlign = "right";

                // 横線 (Y軸) & 数値
                const hStep = h / 4;
                for(let i=0; i<=4; i++) {
                    const y = i * hStep;
                    c.beginPath(); c.moveTo(0, y); c.lineTo(w, y); c.stroke();
                    
                    // 数値 (+1.0, +0.5, 0.0, -0.5, -1.0)
                    let val = (1 - (i * 0.5)).toFixed(1);
                    if(i === 0) val = "+1.0";
                    if(i === 4) val = "-1.0";
                    if(i !== 2) { // 0.0は中央線と被るので避けるか、中央線だけ色を変える
                        c.fillText(val, 40, y + 4); 
                    }
                }

                // 中心線 (0.0)
                c.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                c.beginPath(); c.moveTo(0, h/2); c.lineTo(w, h/2); c.stroke();
                c.fillText("0.0", 40, h/2 - 4);

                // 縦線 (X軸 - Time)
                c.strokeStyle = 'rgba(148, 163, 184, 0.15)';
                c.textAlign = "center";
                const wStep = w / 8;
                for(let i=1; i<8; i++) {
                    const x = i * wStep;
                    c.beginPath(); c.moveTo(x, 0); c.lineTo(x, h); c.stroke();
                    // c.fillText(`${i}ms`, x, h - 5);
                }
            },

            drawRadar: function(sync) {
                const ctx = document.getElementById('radarChart').getContext('2d');
                // チャートの色設定（神羅万象スタイル）
                Chart.defaults.color = '#94a3b8'; // Slate-400
                Chart.defaults.borderColor = 'rgba(148, 163, 184, 0.1)';
                
                if(this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['木 (WOOD)', '火 (FIRE)', '土 (EARTH)', '金 (METAL)', '水 (WATER)'],
                        datasets: [{
                            label: 'ENERGY SYNC',
                            data: [85, 80, 90, 85, sync],
                            backgroundColor: 'rgba(250, 204, 21, 0.2)', // Yellow-400 low alpha
                            borderColor: '#facc15', // Yellow-400
                            borderWidth: 2,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#facc15'
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                angleLines: { color: 'rgba(255,255,255,0.05)' },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                pointLabels: { font: { size: 10 } },
                                min: 0, max: 100,
                                ticks: { display: false }
                            }
                        },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            },

            download: function() {
                alert("共鳴ファイル(.wav)のダウンロードを開始します...");
                const a = document.createElement("a");
                a.href = "#"; a.download = "astro_resonance.wav"; a.click();
            },

            showStep: function(id) {
                const el = document.getElementById(id);
                el.classList.remove('hidden');
                el.classList.add('step-anim');
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
